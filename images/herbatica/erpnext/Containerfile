# Custom ERPNext image with XML Importer app
# Based on official ERPNext image with additional custom apps

FROM frappe/erpnext:develop

# Switch to frappe user for app installation
USER frappe

# Set working directory to bench
WORKDIR /home/frappe/frappe-bench

# Install XML Importer app from your GitHub repository
RUN bench get-app xml_importer https://github.com/UhrinDavid/erpnext_xml_importer.git

RUN bench get-app https://github.com/UhrinDavid/barcode_to_item_id.git --branch develop

# Install Raven app from The-Commit-Company repository
RUN bench get-app https://github.com/The-Commit-Company/Raven.git

# Install custom apps
RUN bench get-app https://github.com/developmentforpeople/dfp_external_storage.git

RUN bench get-app https://github.com/Mohtashim-1/Invoice-OCR.git

# Install missing dependencies for custom apps
# dfp_external_storage needs: minio
# invoice_ocr needs: pytesseract, pdf2image, Pillow, PyPDF2
RUN bench pip install minio pytesseract pdf2image Pillow PyPDF2
# Switch back to root for system packages and final configurations
USER root

# Install system dependencies for OCR and PDF processing
RUN apt-get update && apt-get install -y \
    tesseract-ocr \
    poppler-utils \
    && rm -rf /var/lib/apt/lists/*

# Set proper ownership
RUN chown -R frappe:frappe /home/frappe/frappe-bench

# Switch back to frappe user for runtime
USER frappe

# Keep the original entrypoint from base image
# No need to override CMD - inherits from base image